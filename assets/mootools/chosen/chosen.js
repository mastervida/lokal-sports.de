/* Chosen by Patrick Filler, Jules Janssen, Jonnathan Soares, MIT-style license */
Elements.implement({chosen:function(e){return this.each(function(t){if(!t.hasClass("chzn-done"))return new Chosen(t,e)})}});var Chosen=new Class({Implements:Options,Binds:["test_active_click","container_mousedown","container_mouseup","mouse_enter","mouse_leave","search_results_mouseup","search_results_mouseover","search_results_mouseout","input_blur","keyup_checker","keydown_checker","choices_click","input_focus","activate_field","results_update_field"],options:{allow_single_deselect:!1,disable_search_threshold:0},active_field:!1,mouse_on_container:!1,results_showing:!1,result_highlighted:null,result_single_selected:null,choices:0,initialize:function(e,t){this.setOptions(t),this.form_field=e,this.is_multiple=this.form_field.multiple,this.is_rtl=this.form_field.hasClass("chzn-rtl"),this.set_up_html(),this.register_observers(),this.form_field.addClass("chzn-done")},set_up_html:function(){this.form_field.get("id")||this.form_field.set("id",String.uniqueID()),this.container_id=this.form_field.id.replace(/(:|\.)/g,"_")+"_chzn",this.f_width=this.form_field.measure(function(){return this.getSize().x>0?this.getSize().x:this.getStyle("width").toInt()}),this.default_text=this.form_field.get("data-placeholder")?this.form_field.get("data-placeholder"):Locale.get("Chosen.placeholder",this.form_field.multiple),this.container=new Element("div",{id:this.container_id,"class":"chzn-container"+(this.is_rtl?" chzn-rtl":"")+" chzn-container-"+(this.is_multiple?"multi":"single"),styles:{width:this.f_width}}),this.is_multiple?this.container.set("html",'<ul class="chzn-choices"><li class="search-field"><input type="text" value="'+this.default_text+'" class="default" autocomplete="off" style="width:25px;" /></li></ul><div class="chzn-drop" style="left:-9000px;"><ul class="chzn-results"></ul></div>'):this.container.set("html",'<a href="javascript:void(0)" class="chzn-single"><span>'+this.default_text+'</span><div><b></b></div></a><div class="chzn-drop" style="left:-9000px;"><div class="chzn-search"><input type="text" autocomplete="off" /></div><ul class="chzn-results"></ul></div>'),this.form_field.setStyle("display","none").grab(this.container,"after"),this.dropdown=this.container.getElement("div.chzn-drop");var e=this.container.getCoordinates().height,t=this.f_width-this.dropdown.get_side_border_padding();this.dropdown.setStyles({width:t,top:e}),this.search_field=this.container.getElement("input"),this.search_results=this.container.getElement("ul.chzn-results"),this.search_field_scale(),this.search_no_results=this.container.getElement("li.no-results");if(this.is_multiple)this.search_choices=this.container.getElement("ul.chzn-choices"),this.search_container=this.container.getElement("li.search-field");else{this.search_container=this.container.getElement("div.chzn-search"),this.selected_item=this.container.getElement(".chzn-single");var n=t-this.search_container.get_side_border_padding()-this.search_field.get_side_border_padding();this.search_field.setStyle("width",n)}this.results_build(),this.set_tab_index(),this.form_field.fireEvent("liszt:ready",this)},register_observers:function(){this.container.addEvents({mousedown:this.container_mousedown,mouseup:this.container_mouseup,mouseenter:this.mouse_enter,mouseleave:this.mouse_leave}),this.search_results.addEvents({mouseup:this.search_results_mouseup,mouseover:this.search_results_mouseover,mouseout:this.search_results_mouseout}),this.form_field.addEvent("liszt:updated",this.results_update_field),this.search_field.addEvents({blur:this.input_blur,keyup:this.keyup_checker,keydown:this.keydown_checker}),this.is_multiple?(this.search_choices.addEvent("click",this.choices_click),this.search_field.addEvent("focus",this.input_focus)):this.selected_item.addEvent("focus",this.activate_field)},unregister_observers:function(){this.container.removeEvents({mousedown:this.container_mousedown,mouseup:this.container_mouseup,mouseenter:this.mouse_enter,mouseleave:this.mouse_leave}),this.search_results.removeEvents({mouseup:this.search_results_mouseup,mouseover:this.search_results_mouseover,mouseout:this.search_results_mouseout}),this.form_field.removeEvent("liszt:updated",this.results_update_field),this.search_field.removeEvents({blur:this.input_blur,keyup:this.keyup_checker,keydown:this.keydown_checker}),this.is_multiple?(this.search_choices.removeEvent("click",this.choices_click),this.search_field.removeEvent("focus",this.input_focus)):this.selected_item.removeEvent("focus",this.activate_field),document.removeEvent("click",this.test_active_click)},search_field_disabled:function(){this.is_disabled=this.form_field.get("disabled"),this.is_disabled?(this.container.addClass("chzn-disabled"),this.search_field.set("disabled",!0),this.is_multiple||this.selected_item.removeEvent("focus",this.activate_field),this.close_field()):(this.container.removeClass("chzn-disabled"),this.search_field.set("disabled",!1),this.is_multiple||this.selected_item.addEvent("focus",this.activate_field))},container_mousedown:function(e){if(!this.is_disabled){var t=e!=null?e.target.hasClass("search-choice-close"):!1;e&&e.type==="mousedown"&&e.stopPropagation(),!this.pending_destroy_click&&!t?(this.active_field?!this.is_multiple&&e&&(e.target===this.selected_item||e.target.getParents("a.chzn-single").length)&&(e.preventDefault(),this.results_toggle()):(this.is_multiple&&this.search_field.set("value",""),document.addEvent("click",this.test_active_click),this.results_show()),this.activate_field()):this.pending_destroy_click=!1}},container_mouseup:function(e){if(e.target.get("tag").toUpperCase()==="ABBR")return this.results_reset(e)},mouse_enter:function(){this.mouse_on_container=!0},mouse_leave:function(){this.mouse_on_container=!1},input_focus:function(e){this.active_field||setTimeout(this.container_mousedown,50)},input_blur:function(e){this.mouse_on_container||(this.active_field=!1,setTimeout(this.blur_test.bind(this),100))},blur_test:function(e){!this.active_field&&this.container.hasClass("chzn-container-active")&&this.close_field()},close_field:function(){document.removeEvent("click",this.test_active_click),this.is_multiple||(this.selected_item.set("tabindex",this.search_field.get("tabindex")),this.search_field.set("tabindex",-1)),this.active_field=!1,this.results_hide(),this.container.removeClass("chzn-container-active"),this.winnow_results_clear(),this.clear_backstroke(),this.show_search_field_default(),this.search_field_scale()},activate_field:function(){!this.is_multiple&&!this.active_field&&(this.search_field.set("tabindex",this.selected_item.get("tabindex")),this.selected_item.set("tabindex",-1)),this.container.addClass("chzn-container-active"),this.active_field=!0,this.search_field.set("value",this.search_field.get("value")),this.search_field.focus()},test_active_click:function(e){e.target.getParents("#"+this.container_id).length?this.active_field=!0:this.close_field()},results_build:function(){this.parsing=!0,this.results_data=this.form_field.select_to_array(),this.is_multiple&&this.choices>0?(this.search_choices.getElements("li.search-choice").destroy(),this.choices=0):this.is_multiple||(this.selected_item.getElements("span").set("text",this.default_text),this.form_field.options.length<=this.options.disable_search_threshold?this.container.addClass("chzn-container-single-nosearch"):this.container.removeClass("chzn-container-single-nosearch"));var e="";this.results_data.each(function(t){t.group?e+=this.result_add_group(t):t.empty||(e+=this.result_add_option(t),t.selected&&this.is_multiple?this.choice_build(t):t.selected&&!this.is_multiple&&(this.selected_item.getElements("span").set("html",t.html),this.options.allow_single_deselect&&this.single_deselect_control_build()))},this),this.search_field_disabled(),this.show_search_field_default(),this.search_field_scale(),this.search_results.set("html",e),this.parsing=!1},result_add_group:function(e){return e.disabled?"":(e.dom_id=this.container_id+"_g_"+e.array_index,'<li id="'+e.dom_id+'" class="group-result"><div>'+e.label+"</div></li>")},result_add_option:function(e){if(!e.disabled){e.dom_id=this.container_id+"_o_"+e.array_index;var t=e.selected&&this.is_multiple?[]:["active-result"];e.selected&&t.push("result-selected"),e.group_array_index!=null&&t.push("group-option"),e.classes!==""&&t.push(e.classes);var n=e.style.cssText!==""?' style="'+e.style+'"':"";return'<li id="'+e.dom_id+'" class="'+t.join(" ")+'"'+n+">"+e.html+"</li>"}return""},results_update_field:function(){this.result_clear_highlight(),this.result_single_selected=null,this.results_build()},result_do_highlight:function(e){if(e){this.result_clear_highlight(),this.result_highlight=e,this.result_highlight.addClass("highlighted");var t=parseInt(this.search_results.getStyle("maxHeight"),10),n=this.search_results.getScroll().y,r=t+n,i=this.result_highlight.getPosition(this.search_results).y+this.search_results.getScroll().y,s=i+this.result_highlight.getCoordinates().height;s>=r?this.search_results.scrollTo(0,s-t>0?s-t:0):i<n&&this.search_results.scrollTo(0,i)}},result_clear_highlight:function(){this.result_highlight&&this.result_highlight.removeClass("highlighted"),this.result_highlight=null},results_toggle:function(){this.results_showing?this.results_hide():this.results_show()},results_show:function(){this.is_multiple||(this.selected_item.addClass("chzn-single-with-drop"),this.result_single_selected&&this.result_do_highlight(this.result_single_selected));var e=this.is_multiple?this.container.getCoordinates().height:this.container.getCoordinates().height-1;this.dropdown.setStyles({top:e,left:0}),this.results_showing=!0,this.search_field.focus(),this.search_field.set("value",this.search_field.get("value")),this.winnow_results()},results_hide:function(){this.is_multiple||this.selected_item.removeClass("chzn-single-with-drop"),this.result_clear_highlight(),this.dropdown.setStyle("left",-9e3),this.results_showing=!1},set_tab_index:function(e){if(this.form_field.get("tabindex")){var t=this.form_field.get("tabindex");this.form_field.set("tabindex",-1),this.is_multiple?this.search_field.set("tabindex",t):(this.selected_item.set("tabindex",t),this.search_field.set("tabindex",-1))}},show_search_field_default:function(){this.is_multiple&&this.choices<1&&!this.active_field?(this.search_field.set("value",this.default_text),this.search_field.addClass("default")):(this.search_field.set("value",""),this.search_field.removeClass("default"))},search_results_mouseup:function(e){var t=e.target.hasClass("active-result")?e.target:e.target.getParent(".active-result");t&&(this.result_highlight=t,this.result_select(e))},search_results_mouseover:function(e){var t=e.target.hasClass("active-result")?e.target:e.target.getParent(".active-result");t&&this.result_do_highlight(t)},search_results_mouseout:function(e){(e.target.hasClass("active-result")||e.target.getParent(".active-result"))&&this.result_clear_highlight()},choices_click:function(e){e.preventDefault(),this.active_field&&!e.target.hasClass("search-choice")&&!e.target.getParent(".search-choice")&&!this.results_showing&&this.results_show()},choice_build:function(e){var t=this.container_id+"_c_"+e.array_index;this.choices+=1;var n=(new Element("li",{id:t})).addClass("search-choice").set("html","<span>"+e.html+'</span><a href="#" class="search-choice-close" rel="'+e.array_index+'"></a>');this.search_container.grab(n,"before"),n.getElement("a").addEvent("click",this.choice_destroy_link_click.bind(this))},choice_destroy_link_click:function(e){e.preventDefault(),this.is_disabled?e.stop():(this.pending_destroy_click=!0,this.choice_destroy(e.target))},choice_destroy:function(e){this.choices-=1,this.show_search_field_default(),this.is_multiple&&this.choices>0&&this.search_field.value.length<1&&this.results_hide(),this.result_deselect(e.get("rel")),e.getParent("li").destroy()},results_reset:function(e){this.form_field.options[0].selected=!0,this.selected_item.getElement("span").set("text",this.default_text),this.show_search_field_default(),e.target.destroy(),this.form_field.fireEvent("change"),this.active_field&&this.results_hide()},result_select:function(e){if(this.result_highlight){var t=this.result_highlight,n=t.id;this.result_clear_highlight();if(this.is_multiple)this.result_deactivate(t);else{var r=this.search_results.getElement(".result-selected");r&&r.removeClass("result-selected"),this.result_single_selected=t}t.addClass("result-selected");var i=n.substr(n.lastIndexOf("_")+1),s=this.results_data[i];s.selected=!0,this.form_field.options[s.options_index].selected=!0,this.is_multiple?this.choice_build(s):(this.selected_item.getElement("span").set("text",s.text),this.options.allow_single_deselect&&this.single_deselect_control_build()),(!this.is_multiple||!e.control)&&this.results_hide(),this.search_field.set("value",""),this.form_field.fireEvent("change"),typeof this.form_field.onchange=="function"&&this.form_field.onchange(),this.search_field_scale()}},result_activate:function(e){e.addClass("active-result")},result_deactivate:function(e){e.removeClass("active-result")},result_deselect:function(e){var t=this.results_data[e];t.selected=!1,this.form_field.options[t.options_index].selected=!1;var n=document.id(this.container_id+"_o_"+e);n.removeClass("result-selected").addClass("active-result").setStyle("display","block"),this.result_clear_highlight(),this.winnow_results(),this.form_field.fireEvent("change"),this.search_field_scale()},single_deselect_control_build:function(){if(this.options.allow_single_deselect&&this.selected_item.getElements("abbr").length<1)return this.selected_item.getElement("span").grab(new Element("abbr",{"class":"search-choice-close"}),"before")},results_search:function(e){this.results_showing?this.winnow_results():this.results_show()},winnow_results:function(){this.no_results_clear();var e=0,t=this.search_field.get("value")===this.default_text?"":(new Element("div",{text:this.search_field.get("value").trim()})).get("html"),n=new RegExp(t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i");zregex=new RegExp(t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i"),this.results_data.each(function(r){if(!r.disabled&&!r.empty)if(r.group)document.id(r.dom_id).setStyle("display","none");else if(!this.is_multiple||!r.selected){var i=!1,s=r.dom_id,o=$(s);if(n.test(r.html))i=!0,e+=1;else if(r.html.indexOf(" ")>=0||r.html.indexOf("[")===0){var u=r.html.replace(/\[|\]/g,"").split(" ");u.length&&u.each(function(t){n.test(t)&&(i=!0,e+=1)})}if(i){var a;if(t.length){var f=r.html.search(zregex);a=r.html.substr(0,f+t.length)+"</em>"+r.html.substr(f+t.length),a=a.substr(0,f)+"<em>"+a.substr(f)}else a=r.html;o.set("html",a),this.result_activate(o),r.group_array_index!=null&&document.id(this.results_data[r.group_array_index].dom_id).setStyle("display","list-item")}else this.result_highlight&&s===this.result_highlight.id&&this.result_clear_highlight(),this.result_deactivate(o)}},this),e<1&&t.length?this.no_results(t):this.winnow_results_set_highlight()},winnow_results_clear:function(){this.search_field.set("value",""),this.search_results.getElements("li").each(function(e){e.hasClass("group-result")?e.setStyle("display","block"):!this.is_multiple||!e.hasClass("result-selected")?this.result_activate(e):void 0},this)},winnow_results_set_highlight:function(){if(!this.result_highlight){var e=this.is_multiple?[]:this.search_results.getElements(".result-selected"),t=e.length?e[0]:this.search_results.getElement(".active-result");t!=null&&this.result_do_highlight(t)}},no_results:function(e){var t=(new Element("li",{"class":"no-results"})).set("html",Locale.get("Chosen.noResults")+' "<span></span>"');t.getElement("span").set("html",e),this.search_results.grab(t)},no_results_clear:function(){this.search_results.getElements(".no-results").destroy()},keydown_arrow:function(){if(!this.result_highlight){var e=this.search_results.getElement("li.active-result");e&&this.result_do_highlight(e)}else if(this.results_showing){var t=this.result_highlight.getNext("li.active-result");t&&this.result_do_highlight(t)}this.results_showing||this.results_show()},keyup_arrow:function(){if(!this.results_showing&&!this.is_multiple)this.results_show();else if(this.result_highlight){var e=this.result_highlight.getPrevious("li.active-result");e?this.result_do_highlight(e):(this.choices>0&&this.results_hide(),this.result_clear_highlight())}},keydown_backstroke:function(){this.pending_backstroke?(this.choice_destroy(this.pending_backstroke.getElement("a")),this.clear_backstroke()):(this.pending_backstroke=this.search_choices.getLast("li.search-choice"),this.pending_backstroke.addClass("search-choice-focus"))},clear_backstroke:function(){this.pending_backstroke&&this.pending_backstroke.removeClass("search-choice-focus"),this.pending_backstroke=null},keyup_checker:function(e){this.search_field_scale();switch(e.key){case"backspace":this.is_multiple&&this.backstroke_length<1&&this.choices>0?this.keydown_backstroke():this.pending_backstroke||(this.result_clear_highlight(),this.results_search());break;case"enter":e.preventDefault(),this.results_showing&&this.result_select(e);break;case"esc":this.results_showing&&this.results_hide();break;case"tab":case"up":case"down":case"shift":case"ctrl":break;default:this.results_search()}},keydown_checker:function(e){this.search_field_scale(),e.key!=="backspace"&&this.pending_backstroke&&this.clear_backstroke();switch(e.key){case"backspace":this.backstroke_length=this.search_field.value.length;break;case"tab":this.results_showing&&!this.is_multiple&&this.result_select(e),this.mouse_on_container=!1;break;case"enter":e.preventDefault();break;case"up":e.preventDefault(),this.keyup_arrow();break;case"down":this.keydown_arrow()}},search_field_scale:function(){if(this.is_multiple){var e=0,t=0,n={position:"absolute",left:"-1000px",top:"-1000px",display:"none"},r=this.search_field.getStyles("font-size","font-style","font-weight","font-family","line-height","text-transform","letter-spacing");Object.merge(n,r);var i=new Element("div",{styles:n});i.set("text",this.search_field.get("value")),$(document.body).grab(i),t=i.getDimensions().width+25,i.destroy(),t>this.f_width-10&&(t=this.f_width-10),this.search_field.setStyle("width",t);var s=this.container.getCoordinates().height;this.dropdown.setStyle("top",s)}}});Element.implement({get_side_border_padding:function(){var e=this.getStyles("padding-left","padding-right","border-left-width","border-right-width"),t=Object.filter(e,function(e){return typeof e=="string"}),n=Object.map(t,function(e){return e.toInt()}),r=Object.values(n),i=0,s=r.length;if(s)while(s--)i+=r[s];return i},select_to_array:function(){var e=new SelectParser;return this.getChildren().each(function(t){e.add_node(t)}),e.parsed}});var SelectParser=new Class({options_index:0,parsed:[],add_node:function(e){e.nodeName.toUpperCase()==="OPTGROUP"?this.add_group(e):this.add_option(e)},add_group:function(e){var t=this.parsed.length;this.parsed.push({array_index:t,group:!0,label:e.label,children:0,disabled:e.disabled}),e.getChildren().each(function(n){this.add_option(n,t,e.disabled)},this)},add_option:function(e,t,n){e.nodeName.toUpperCase()==="OPTION"&&(e.text!==""?(t!=null&&(this.parsed[t].children+=1),this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,value:e.get("value"),text:e.get("text").trim(),html:e.get("html").replace("[",'<span style="color:#b3b3b3;padding-left:3px">[').replace("]","]</span>"),selected:e.selected,disabled:n===!0?n:e.disabled,group_array_index:t,classes:e.className,style:e.style.cssText})):this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,empty:!0}),this.options_index+=1)}});